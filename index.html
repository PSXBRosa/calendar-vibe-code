<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar: Layout Final Fix</title>
    <style>
        :root {
            --bg: #f3f4f6;
            --border: #e5e7eb;
            --text: #1f2937;
            --primary: #3b82f6;
            --danger: #ef4444;    
            --warning: #f59e0b;   
            --success: #10b981;   
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 10px; }
        
        .btn, .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text);
        }
        .btn:hover { background-color: #f9fafb; }
        .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-danger { background-color: var(--danger); color: white; border-color: var(--danger); }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-green { background-color: var(--success); color: white; border-color: var(--success); }
        .btn-active { background-color: #e5e7eb; font-weight: bold; border-color: #9ca3af; }

        /* --- HEADER --- */
        header {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0; 
        }
        
        .filter-row {
            border-top: 1px solid var(--border);
            padding-top: 10px;
            gap: 15px;
            flex-wrap: wrap;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #6b7280; }

        /* --- CALENDAR GRID WRAPPER --- */
        #calendar-view {
            flex: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            min-height: 0; 
        }

        #calendar-container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            /* Default Grid (Month) */
            display: grid;
            grid-template-columns: repeat(7, 1fr); 
            grid-auto-rows: minmax(100px, auto);
            gap: 1px;
            background-color: var(--border);
            border: 1px solid var(--border);
            overflow-y: auto; 
        }

        .day-cell { background-color: white; padding: 8px; min-height: 100px; }
        .day-cell.header { background-color: #f9fafb; font-weight: bold; text-align: center; min-height: auto; padding: 10px; }
        .day-number { font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: #6b7280; }
        .not-current-month { background-color: #fafafa; color: #d1d5db; }

        /* --- ITEMS (EVENTS) --- */
        .calendar-item {
            font-size: 0.75rem;
            padding: 3px 6px;
            margin-bottom: 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            color: white; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            font-weight: 500;
            border-left: 4px solid transparent; 
        }
        .prio-high { border-left-color: var(--danger); }
        .prio-medium { border-left-color: var(--warning); }
        .prio-low { border-left-color: var(--success); }
        
        /* --- VIEW SPECIFIC OVERRIDES --- */

        /* WEEK VIEW */
        .view-week #calendar-container {
            grid-template-rows: auto minmax(0, 1fr); 
            grid-auto-rows: unset; 
            overflow-y: hidden; 
        }

        .view-week .day-cell {
            min-height: 0; 
            height: 100%;  
            overflow-y: auto; 
        }
        .view-week .day-cell.header {
            overflow: hidden; 
            height: auto;
        }

        /* YEAR VIEW - FIXED */
        .view-year #calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            /* KEY FIX: Reset rows to allow cards to stack properly */
            grid-auto-rows: minmax(250px, auto);
            
            gap: 20px;
            background: transparent;
            border: none;
            overflow-y: auto !important;
            padding-right: 5px; 
        }

        /* --- YEAR VIEW CARDS --- */
        .month-card { 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            height: auto; 
            min-height: min-content; 
        }

        .month-card h3 { 
            margin: 0 0 10px 0; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 5px; 
            text-align: center; 
            font-size: 1.1rem; 
        }
        
        /* LIST VIEW SPECIFIC */
        .month-event-list { 
            flex: 1; 
            overflow-y: auto; 
            max-height: 250px; 
            min-height: 50px;
        }

        /* GRID VIEW SPECIFIC */
        .mini-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px;
            margin-top: 5px;
        }

        .mini-day { 
            font-size: 0.5rem; 
            text-align: center; 
            aspect-ratio: 1.7 / 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border-radius: 50%; 
            color: var(--text);
        }
        
        .mini-day.header-day {
            font-weight: bold;
            color: #9ca3af;
            aspect-ratio: auto;
            height: 20px;
        }

        .has-item { color: white; font-weight: bold; }

        .year-event-item {
            padding: 6px; margin-bottom: 5px; border-radius: 4px; font-size: 0.8rem;
            display: flex; justify-content: space-between; align-items: center; color: white; cursor: pointer;
        }
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; border: 1px solid rgba(255,255,255,0.8); }
        .dot-high { background-color: var(--danger); }
        .dot-medium { background-color: var(--warning); }
        .dot-low { background-color: var(--success); }

        /* --- FORMS & MODALS --- */
        #create-view, #category-modal, #delete-options-modal {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            overflow-y: auto;
            max-height: 90vh;
        }

        #delete-options-modal { max-width: 400px; }

        #modal-overlay, #delete-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        
        #delete-modal-overlay { z-index: 200; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 8px; border: 1px solid #d1d5db; 
            border-radius: 4px; box-sizing: border-box; 
        }

        .cat-list { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; max-height: 200px; overflow-y: auto; }
        .cat-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px; border-bottom: 1px solid #f3f4f6; cursor: pointer;
        }
        .cat-item:hover { background-color: #f9fafb; }
        .cat-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; display: inline-block; }
        .delete-icon { color: var(--danger); cursor: pointer; padding: 0 5px; font-weight: bold; }

    </style>
</head>
<body>

    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileSelect(event)">

    <div id="modal-overlay" class="hidden">
        <div id="category-modal">
            <h3 id="cat-modal-title" style="margin-top:0">Manage Categories</h3>
            <p style="font-size: 0.8rem; color: #6b7280; margin-bottom: 15px;">Click a category below to edit, or fill the form to add new.</p>
            
            <form onsubmit="handleCategorySubmit(event)">
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="cat-name" required placeholder="e.g. Work, Gym">
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="flex">
                        <input type="color" id="cat-color" value="#3b82f6" style="height: 40px; width: 60px; padding: 0; border: none;">
                        <input type="text" id="cat-color-text" value="#3b82f6" readonly style="flex:1;">
                    </div>
                </div>
                <div class="flex" style="justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn" onclick="toggleCategoryModal(false)">Close</button>
                    <div>
                        <button type="button" id="btn-cat-clear" class="btn hidden" onclick="clearCategoryForm()">Cancel Edit</button>
                        <button type="submit" class="btn btn-primary" id="btn-cat-save">Add Category</button>
                    </div>
                </div>
            </form>

            <div class="cat-list" id="cat-list-container"></div>
        </div>
    </div>

    <div id="delete-modal-overlay" class="hidden">
        <div id="delete-options-modal">
            <h3 style="margin-top:0; color: var(--danger);">Delete Category</h3>
            <p>You are about to delete a category. What should happen to the events linked to it?</p>
            
            <div class="flex-col" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmCategoryDelete('move')">
                    Move events to "General"
                </button>
                <button class="btn btn-danger" onclick="confirmCategoryDelete('delete')">
                    Delete events also
                </button>
                <button class="btn" onclick="closeDeleteModal()" style="margin-top: 10px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <header>
        <div class="flex-between" style="width: 100%;">
            <div class="flex" style="align-items: center;">
                <h2 id="current-date-display" style="margin:0;">Date</h2>
            </div>
            <div class="controls">
                <button class="btn btn-green" onclick="downloadData()">&#128190; Save</button>
                <button class="btn" onclick="triggerFileUpload()">&#128193; Load</button>
                <span>&nbsp;|&nbsp;</span>
                <button class="btn" onclick="changeOffset(-1)">&lt;</button>
                <button class="btn" onclick="changeOffset(1)">&gt;</button>
                <button class="btn" onclick="setView('week')" id="btn-week">Week</button>
                <button class="btn" onclick="setView('month')" id="btn-month">Month</button>
                <button class="btn" onclick="setView('year')" id="btn-year">Year</button>
                <span>&nbsp;|&nbsp;</span>
                <button class="btn btn-primary" onclick="openEventForm()">+ New Event</button>
            </div>
        </div>
        
        <div class="flex-center filter-row">
            <div class="filter-group">
                <span>Filter By:</span>
                <select id="filter-category" class="filter-select" onchange="setFilter('category', this.value)"></select>
                <select id="filter-priority" class="filter-select" onchange="setFilter('priority', this.value)">
                    <option value="all">All Priorities</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <button class="btn" onclick="toggleCategoryModal(true)">Manage Categories</button>
            </div>

            <div id="year-controls" class="filter-group hidden" style="margin-left: 20px; border-left: 1px solid var(--border); padding-left: 20px;">
                <span>View Mode:</span>
                <button class="btn" id="btn-mode-list" onclick="setYearMode('list')">List</button>
                <button class="btn" id="btn-mode-grid" onclick="setYearMode('grid')">Grid</button>
            </div>
        </div>
    </header>

    <div id="calendar-view">
        <div id="calendar-container"></div>
    </div>

    <div id="create-view" class="hidden">
        <div class="flex-between" style="margin-bottom: 20px;">
            <h2 style="margin:0" id="form-title">Create New Event</h2>
        </div>
        
        <form id="create-form" onsubmit="handleItemSubmit(event)">
            <div class="form-group">
                <label>Event Name</label>
                <input type="text" id="inp-name" required>
            </div>
            
            <div class="flex">
                <div class="form-group" style="flex: 1;">
                    <label>Date</label>
                    <input type="date" id="inp-date" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Priority</label>
                    <select id="inp-priority">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Category</label>
                <select id="inp-category" required style="width:100%"></select>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="inp-desc" rows="3"></textarea>
            </div>

            <div class="flex" style="justify-content: space-between; margin-top: 20px;">
                <button type="button" id="btn-delete-event" class="btn btn-danger hidden" onclick="deleteEvent()">Delete Event</button>
                <div class="flex">
                    <button type="button" class="btn" onclick="showCalendarPage()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Event</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // --- DATA STATE ---
        let events = [];
        let categories = [
            { id: 'default', name: 'General', color: '#6b7280' }
        ];

        // --- APP STATE ---
        let state = { 
            view: 'month', 
            currentDate: new Date(), 
            yearMode: 'list',
            filterCategory: 'all',
            filterPriority: 'all',
            editingEventId: null,
            editingCategoryId: null,
            categoryPendingDelete: null 
        };
        
        // --- FILE HANDLING ---
        function downloadData() {
            const data = { events, categories, savedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `calendar_backup.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function triggerFileUpload() { document.getElementById('file-input').click(); }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (json.events && json.categories) {
                        events = json.events;
                        categories = json.categories;
                        alert("Data loaded successfully!");
                        updateCategoryDropdowns();
                        render();
                    } else {
                        alert("Invalid file format.");
                    }
                } catch (err) { alert("Error reading file."); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- DOM REFS ---
        const views = {
            calendar: document.getElementById('calendar-view'),
            create: document.getElementById('create-view'),
            modal: document.getElementById('modal-overlay'),
            deleteModal: document.getElementById('delete-modal-overlay'),
            yearControls: document.getElementById('year-controls')
        };
        const container = document.getElementById('calendar-container');

        // --- COLORS ---
        document.getElementById('cat-color').addEventListener('input', (e) => {
            document.getElementById('cat-color-text').value = e.target.value;
        });

        function getCategoryColor(catId) {
            const cat = categories.find(c => c.id == catId);
            return cat ? cat.color : '#6b7280';
        }

        // --- NAVIGATION ---
        function showCalendarPage() {
            views.create.classList.add('hidden');
            views.calendar.classList.remove('hidden');
            render();
        }

        function openEventForm(eventId = null) {
            views.calendar.classList.add('hidden');
            views.create.classList.remove('hidden');
            state.editingEventId = eventId;
            updateCategoryDropdowns(); 

            if (eventId) {
                const ev = events.find(e => e.id === eventId);
                document.getElementById('form-title').innerText = "Edit Event";
                document.getElementById('inp-name').value = ev.name;
                document.getElementById('inp-date').value = ev.date;
                document.getElementById('inp-priority').value = ev.priority;
                document.getElementById('inp-category').value = ev.categoryId;
                document.getElementById('inp-desc').value = ev.description;
                document.getElementById('btn-delete-event').classList.remove('hidden');
            } else {
                document.getElementById('create-form').reset();
                document.getElementById('form-title').innerText = "Create New Event";
                document.getElementById('inp-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('btn-delete-event').classList.add('hidden');
            }
        }

        // --- CATEGORY MODAL LOGIC ---
        function toggleCategoryModal(show) {
            if(show) {
                views.modal.classList.remove('hidden');
                clearCategoryForm();
                renderCategoryList();
            } else {
                views.modal.classList.add('hidden');
            }
        }

        function clearCategoryForm() {
            state.editingCategoryId = null;
            document.getElementById('cat-name').value = '';
            document.getElementById('cat-color').value = '#3b82f6';
            document.getElementById('cat-color-text').value = '#3b82f6';
            document.getElementById('btn-cat-save').innerText = "Add Category";
            document.getElementById('btn-cat-clear').classList.add('hidden');
        }

        function loadCategoryForEdit(id) {
            const cat = categories.find(c => c.id == id);
            if(!cat) return;
            state.editingCategoryId = id;
            document.getElementById('cat-name').value = cat.name;
            document.getElementById('cat-color').value = cat.color;
            document.getElementById('cat-color-text').value = cat.color;
            document.getElementById('btn-cat-save').innerText = "Update Category";
            document.getElementById('btn-cat-clear').classList.remove('hidden');
        }

        function renderCategoryList() {
            const list = document.getElementById('cat-list-container');
            list.innerHTML = '';
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'cat-item';
                
                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.innerHTML = `<span class="cat-dot" style="background:${cat.color}"></span> ${cat.name}`;
                left.onclick = () => loadCategoryForEdit(cat.id);
                
                const right = document.createElement('div');
                if(cat.id !== 'default') {
                    right.innerHTML = '&times;';
                    right.className = 'delete-icon';
                    right.title = 'Delete Category';
                    right.onclick = (e) => {
                        e.stopPropagation();
                        promptDeleteCategory(cat.id);
                    };
                }
                div.appendChild(left);
                div.appendChild(right);
                list.appendChild(div);
            });
        }

        // --- DELETE CATEGORY LOGIC ---
        
        function promptDeleteCategory(id) {
            state.categoryPendingDelete = id;
            views.deleteModal.classList.remove('hidden');
        }

        function closeDeleteModal() {
            state.categoryPendingDelete = null;
            views.deleteModal.classList.add('hidden');
        }

        function confirmCategoryDelete(action) {
            const idToDelete = state.categoryPendingDelete;
            if(!idToDelete) return;

            const idString = String(idToDelete);

            if (action === 'move') {
                events.forEach(ev => {
                    if (String(ev.categoryId) === idString) {
                        ev.categoryId = 'default';
                    }
                });
            } else if (action === 'delete') {
                events = events.filter(ev => String(ev.categoryId) !== idString);
            }

            categories = categories.filter(c => String(c.id) !== idString);

            if(state.editingCategoryId === idToDelete) clearCategoryForm();
            if(String(state.filterCategory) === idString) state.filterCategory = 'all';

            closeDeleteModal();
            renderCategoryList();
            updateCategoryDropdowns();
            render(); 
        }

        // --- FORM SUBMISSIONS ---
        
        function handleItemSubmit(e) {
            e.preventDefault();
            const eventData = {
                id: state.editingEventId ? state.editingEventId : Date.now(),
                name: document.getElementById('inp-name').value,
                description: document.getElementById('inp-desc').value,
                categoryId: document.getElementById('inp-category').value,
                date: document.getElementById('inp-date').value,
                priority: document.getElementById('inp-priority').value 
            };

            if (state.editingEventId) {
                const index = events.findIndex(ev => ev.id === state.editingEventId);
                if(index !== -1) events[index] = eventData;
            } else {
                events.push(eventData);
            }
            showCalendarPage();
        }

        function deleteEvent() {
            if(!state.editingEventId) return;
            if(confirm("Are you sure you want to delete this event?")) {
                events = events.filter(ev => ev.id !== state.editingEventId);
                showCalendarPage();
            }
        }

        function handleCategorySubmit(e) {
            e.preventDefault();
            const name = document.getElementById('cat-name').value;
            const color = document.getElementById('cat-color').value;

            if (state.editingCategoryId) {
                const cat = categories.find(c => c.id === state.editingCategoryId);
                if(cat) {
                    cat.name = name;
                    cat.color = color;
                }
            } else {
                categories.push({ id: Date.now(), name, color });
            }
            clearCategoryForm();
            renderCategoryList();
            updateCategoryDropdowns();
            render(); 
        }

        // --- DROPDOWN UPDATES ---
        function updateCategoryDropdowns() {
            // Create Form
            const createSelect = document.getElementById('inp-category');
            const currentCreateVal = createSelect.value;
            createSelect.innerHTML = '';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.innerText = cat.name;
                createSelect.appendChild(opt);
            });
            if([...createSelect.options].some(o => o.value == currentCreateVal)) {
                createSelect.value = currentCreateVal;
            } else {
                createSelect.value = 'default';
            }

            // Filter
            const filterSelect = document.getElementById('filter-category');
            const currentFilterVal = filterSelect.value;
            filterSelect.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.innerText = cat.name;
                filterSelect.appendChild(opt);
            });
            if([...filterSelect.options].some(o => o.value == currentFilterVal)) {
                filterSelect.value = currentFilterVal;
            } else {
                filterSelect.value = 'all';
                state.filterCategory = 'all';
            }
        }

        function setYearMode(mode) {
            state.yearMode = mode;
            render();
        }

        function setFilter(type, value) {
            if (type === 'category') state.filterCategory = value;
            if (type === 'priority') state.filterPriority = value;
            render();
        }

        // --- RENDER LOGIC ---
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function createEventElement(item) {
            const color = getCategoryColor(item.categoryId);
            const el = document.createElement('div');
            el.className = `calendar-item prio-${item.priority || 'low'}`;
            el.innerText = item.name;
            el.title = `${item.name} (${item.priority})`;
            el.style.backgroundColor = color;
            el.onclick = (e) => {
                e.stopPropagation();
                openEventForm(item.id);
            };
            return el;
        }

        function render() {
            const filteredEvents = events.filter(ev => {
                const catMatch = state.filterCategory === 'all' || String(ev.categoryId) === String(state.filterCategory);
                const prioMatch = state.filterPriority === 'all' || ev.priority === state.filterPriority;
                return catMatch && prioMatch;
            });

            const options = { year: 'numeric', month: 'long' };
            if (state.view === 'week') options.day = 'numeric';
            document.getElementById('current-date-display').innerText = state.currentDate.toLocaleDateString('en-US', options);

            document.querySelectorAll('.controls .btn').forEach(b => {
                if(b.id && b.id.startsWith('btn-')) b.classList.remove('btn-primary');
            });
            if(document.getElementById(`btn-${state.view}`)) 
                document.getElementById(`btn-${state.view}`).classList.add('btn-primary');

            if (state.view === 'year') {
                views.yearControls.classList.remove('hidden');
                document.getElementById('btn-mode-list').className = `btn ${state.yearMode === 'list' ? 'btn-active' : ''}`;
                document.getElementById('btn-mode-grid').className = `btn ${state.yearMode === 'grid' ? 'btn-active' : ''}`;
            } else {
                views.yearControls.classList.add('hidden');
            }

            container.innerHTML = '';
            views.calendar.className = `view-${state.view}`;
            container.style = ''; 

            if (state.view === 'month') {
                container.style.display = 'grid';
                container.style.gridTemplateColumns = 'repeat(7, 1fr)';
                renderMonth(filteredEvents);
            } else if (state.view === 'week') {
                container.style.display = 'grid';
                container.style.gridTemplateColumns = 'repeat(7, 1fr)';
                container.style.gridAutoRows = '1fr';
                renderWeek(filteredEvents);
            } else if (state.view === 'year') {
                if(state.yearMode === 'list') renderYearList(filteredEvents);
                else renderYearGrid(filteredEvents);
            }
        }

        function renderMonth(data) {
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
                const el = document.createElement('div');
                el.className = 'day-cell header';
                el.innerText = d;
                container.appendChild(el);
            });
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) container.appendChild(document.createElement('div'));

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = new Date(year, month, i).toISOString().split('T')[0];
                const items = data.filter(ev => ev.date === dateStr);
                const el = document.createElement('div');
                el.className = 'day-cell';
                el.innerHTML = `<div class="day-number">${i}</div>`;
                items.forEach(item => el.appendChild(createEventElement(item)));
                container.appendChild(el);
            }
        }

        function renderWeek(data) {
            const start = getStartOfWeek(state.currentDate);
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const el = document.createElement('div');
                el.className = 'day-cell header';
                el.innerText = d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
                container.appendChild(el);
            }
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const items = data.filter(ev => ev.date === dateStr);
                const el = document.createElement('div');
                el.className = 'day-cell';
                items.forEach(item => el.appendChild(createEventElement(item)));
                container.appendChild(el);
            }
        }

        function renderYearList(data) {
            const year = state.currentDate.getFullYear();
            const priorityVal = { 'high': 3, 'medium': 2, 'low': 1 };
            for (let m = 0; m < 12; m++) {
                const monthDate = new Date(year, m, 1);
                const monthEvents = data.filter(ev => ev.date.startsWith(`${year}-${String(m+1).padStart(2,'0')}`));
                monthEvents.sort((a, b) => priorityVal[b.priority] - priorityVal[a.priority]);

                const card = document.createElement('div');
                card.className = 'month-card';
                let html = `<h3>${monthDate.toLocaleDateString('en-US', {month:'long'})}</h3><div class="month-event-list">`;
                
                if (monthEvents.length === 0) {
                    html += `<div style="color:#9ca3af; font-size:0.8rem; text-align:center; padding-top:10px;">No events</div>`;
                } else {
                    monthEvents.forEach(ev => {
                        const color = getCategoryColor(ev.categoryId);
                        const day = ev.date.split('-')[2];
                        html += `
                        <div class="year-event-item" style="background-color: ${color}" onclick="openEventForm(${ev.id})">
                            <span><span class="priority-dot dot-${ev.priority}"></span> ${ev.name}</span>
                            <span style="opacity:0.8">${day}</span>
                        </div>`;
                    });
                }
                html += `</div>`;
                card.innerHTML = html;
                container.appendChild(card);
            }
        }

        function renderYearGrid(data) {
            const year = state.currentDate.getFullYear();
            for (let m = 0; m < 12; m++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-card';
                monthDiv.style.display = 'block';
                const monthDate = new Date(year, m, 1);
                
                let html = `<h3>${monthDate.toLocaleDateString('en-US', {month:'long'})}</h3><div class="mini-grid">`;
                ['S','M','T','W','T','F','S'].forEach(d => html += `<div class="mini-day header-day">${d}</div>`);
                
                const startDay = monthDate.getDay();
                const daysInMonth = new Date(year, m+1, 0).getDate();
                for(let b=0; b<startDay; b++) html += `<div></div>`;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const localDate = new Date(year, m, d);
                    const y = localDate.getFullYear();
                    const mo = String(localDate.getMonth() + 1).padStart(2, '0');
                    const da = String(localDate.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${mo}-${da}`;

                    const items = data.filter(ev => ev.date === dateStr);
                    let style = '';
                    let cssClass = '';
                    if(items.length > 0) {
                        const color = getCategoryColor(items[0].categoryId);
                        style = `background-color:${color};`;
                        cssClass = 'has-item';
                    }
                    html += `<div class="mini-day ${cssClass}" style="${style}">${d}</div>`;
                }
                html += `</div>`;
                monthDiv.innerHTML = html;
                container.appendChild(monthDiv);
            }
        }

        function setView(v) { state.view = v; render(); }
        function changeOffset(dir) {
            if (state.view === 'month') state.currentDate.setMonth(state.currentDate.getMonth() + dir);
            else if (state.view === 'week') state.currentDate.setDate(state.currentDate.getDate() + (dir * 7));
            else if (state.view === 'year') state.currentDate.setFullYear(state.currentDate.getFullYear() + dir);
            state.currentDate = new Date(state.currentDate);
            render();
        }

        updateCategoryDropdowns();
        render();

    </script>
</body>
</html>