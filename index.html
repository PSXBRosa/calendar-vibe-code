<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.2.2/alasql.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileSelect(event)">

    <div id="modal-overlay" class="hidden">
        <div id="category-modal">
            <h3 style="margin-top:0; margin-bottom:20px;">Manage Categories</h3>
            <form onsubmit="handleCategorySubmit(event)">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="cat-name" required>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="flex">
                        <input type="color" id="cat-color" value="#3b82f6" style="height: 45px; width: 60px; padding: 0; border: none; cursor:pointer;">
                        <input type="text" id="cat-color-text" value="#3b82f6" readonly style="flex:1;">
                    </div>
                </div>
                <div class="flex" style="justify-content: space-between; margin-top: 24px;">
                    <button type="button" class="btn" onclick="toggleCategoryModal(false)">Close</button>
                    <div>
                        <button type="button" id="btn-cat-clear" class="btn hidden" onclick="clearCategoryForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="btn-cat-save">Add</button>
                    </div>
                </div>
            </form>
            <div class="cat-list" id="cat-list-container"></div>
        </div>
    </div>

    <div id="delete-modal-overlay" class="hidden">
        <div id="delete-options-modal" style="text-align:center;">
            <h3 style="margin:0 0 10px 0;">Delete Category</h3>
            <p style="color:var(--text-light); margin-bottom:24px;">What should happen to the events?</p>
            <div class="flex-col">
                <button class="btn btn-primary" onclick="confirmCategoryDelete('move')">Keep (Move to General)</button>
                <button class="btn btn-danger" onclick="confirmCategoryDelete('delete')">Delete Events</button>
                <button class="btn" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="event-modal-overlay" class="hidden">
        <div id="event-modal">
            <div class="flex-between" style="margin-bottom: 24px;">
                <h2 style="margin:0">Event Info</h2>
                <button type="button" class="btn" onclick="closeEventModal()">&times;</button>
            </div>
            <form id="create-form" onsubmit="handleItemSubmit(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="inp-name" required>
                </div>
                <div class="flex flex-wrap">
                    <div class="form-group" style="flex:1; min-width:140px;">
                        <label>Date</label>
                        <input type="date" id="inp-date" required>
                    </div>
                    <div class="form-group" style="flex:1; min-width:140px;">
                        <label>Priority</label>
                        <select id="inp-priority">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="inp-category" required></select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="inp-desc" rows="4"></textarea>
                </div>
                <div class="flex" style="justify-content: space-between; margin-top: 32px; padding-top:20px; border-top:1px solid var(--border);">
                    <button type="button" class="btn" onclick="closeEventModal()">Cancel</button>
                    <div class="flex">
                        <button type="button" id="btn-delete-event" class="btn btn-danger hidden" onclick="deleteEvent()">Delete</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <header>
        <div class="flex-between" style="width: 100%;">
            <div class="flex-col" style="gap:4px;">
                <h2 id="current-date-display" style="margin:0;">Date</h2>
                <span id="loading-status" style="font-size:0.85rem; color:var(--text-light);"></span>
            </div>
            
            <div class="controls flex-wrap" style="justify-content: flex-end;">
                <div class="btn-group view-switcher">
                    <button class="btn" onclick="setView('week')" id="btn-week">Week</button>
                    <button class="btn" onclick="setView('month')" id="btn-month">Month</button>
                    <button class="btn" onclick="setView('year')" id="btn-year">Year</button>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="changeOffset(-1)">Prev</button>
                    <button class="btn" onclick="changeOffset(1)">Next</button>
                </div>

                <button class="btn btn-dark" onclick="setView('sql')" id="btn-sql">Query</button>
                
                <div class="btn-group">
                    <button class="btn btn-green" onclick="downloadData()">Save</button>
                    <button class="btn" onclick="triggerFileUpload()">Load</button>
                </div>

                <button class="btn btn-primary" onclick="openEventForm()">+ Add Task</button>
            </div>
        </div>
        
        <div id="secondary-controls" class="flex-between" style="border-top: 1px solid var(--border); padding-top: 10px;">
            <div class="flex">
                <button class="btn btn-active" id="btn-toggle-filters" onclick="toggleFilterPanel()">Filters & Layout</button>
                <button class="btn" onclick="toggleCategoryModal(true)">Categories</button>
            </div>
            
            <div id="year-controls" class="flex hidden">
                <div class="btn-group">
                    <button class="btn" id="btn-mode-list" onclick="setYearMode('list')">List</button>
                    <button class="btn" id="btn-mode-grid" onclick="setYearMode('grid')">Grid</button>
                </div>
            </div>
        </div>

        <div id="filter-panel" class="hidden">
            <div class="filter-section" style="flex:2">
                <h4>Categories <span style="font-size:0.7em; cursor:pointer; color:var(--primary); margin-left:8px;" onclick="toggleAllCategories()">[Toggle All]</span></h4>
                <div id="filter-cat-container" class="flex-wrap"></div>
            </div>
            <div class="filter-section">
                <h4>Priorities</h4>
                <div id="filter-prio-container" class="flex-wrap">
                    <div class="chip active" onclick="togglePrio('high', this)"><span class="chip-dot" style="background:var(--danger)"></span>High</div>
                    <div class="chip active" onclick="togglePrio('medium', this)"><span class="chip-dot" style="background:var(--warning)"></span>Med</div>
                    <div class="chip active" onclick="togglePrio('low', this)"><span class="chip-dot" style="background:var(--success)"></span>Low</div>
                </div>
            </div>
            <div class="filter-section" style="flex: 0 0 220px;">
                <h4>Settings</h4>
                <div class="flex-col">
                    <div class="select-wrapper">
                        <select class="input-select" onchange="setSort(this.value)">
                            <option value="priority_desc">Sort: Priority (High)</option>
                            <option value="priority_asc">Sort: Priority (Low)</option>
                            <option value="category_asc">Sort: Category</option>
                            <option value="date_asc">Sort: Date (Old)</option>
                            <option value="date_desc">Sort: Date (New)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="resetLayout()">Reset Grid Sizes</button>
                </div>
            </div>
        </div>
    </header>

    <div id="calendar-view">
        <div id="calendar-container"></div>
    </div>

    <div id="sql-view" class="hidden">
        <div class="flex-between">
            <h2 style="margin:0">SQL Query</h2>
            <div class="flex gap-2">
                <button class="btn" onclick="setSqlQuery('SELECT * FROM events')">All</button>
                <button class="btn" onclick="setSqlQuery('SELECT category_name, COUNT(*) as [Total] FROM events GROUP BY category_name')">By Cat</button>
            </div>
        </div>
        <div class="sql-wrapper">
            <div class="sql-main">
                <textarea id="sql-input" class="sql-editor" placeholder="SELECT * FROM events..."></textarea>
                <button class="btn btn-primary" onclick="runQuery()">Run Query</button>
                <div class="sql-results-container">
                    <table id="sql-results" class="sql-table">
                        <thead><tr><th>Results</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="sql-sidebar">
                <div class="sidebar-box">
                    <div class="sidebar-title">Structure</div>
                    <div class="schema-list" id="schema-list"></div>
                </div>
                <div class="sidebar-box" style="flex:0 0 40%;">
                    <div class="sidebar-title">History</div>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>