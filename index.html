<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar: Scroll & Resize</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.2.2/alasql.min.js"></script>
    
    <style>
        :root {
            --bg: #f3f4f6; --border: #e5e7eb; --text: #1f2937;
            --primary: #3b82f6; --danger: #ef4444; --warning: #f59e0b; --success: #10b981;
            --code-bg: #1e1e1e; --code-text: #d4d4d4;
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; }
        
        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        .flex-wrap { display: flex; flex-wrap: wrap; gap: 8px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 10px; }
        
        /* Controls */
        .btn, .input-select { padding: 8px 12px; border: 1px solid var(--border); background: white; cursor: pointer; border-radius: 4px; font-size: 0.85rem; color: var(--text); }
        .btn:hover { background-color: #f9fafb; }
        .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
        .btn-danger { background-color: var(--danger); color: white; border-color: var(--danger); }
        .btn-green { background-color: var(--success); color: white; border-color: var(--success); }
        .btn-dark { background-color: #374151; color: white; border-color: #374151; }
        .btn-active { background-color: #e5e7eb; font-weight: bold; border-color: #9ca3af; }

        /* Chips */
        .chip { padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; border: 1px solid var(--border); background: white; user-select: none; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .chip.active { background-color: #eff6ff; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .chip-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* Layout */
        header { margin-bottom: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        #filter-panel { border-top: 1px solid var(--border); padding-top: 15px; display: flex; gap: 20px; flex-wrap: wrap; max-height: 150px; overflow-y: auto; }
        .filter-section { flex: 1; min-width: 200px; }
        .filter-section h4 { margin: 0 0 8px 0; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em; }

        #calendar-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        #calendar-container {
            flex: 1; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: grid; gap: 1px; background-color: var(--border); border: 1px solid var(--border);
            overflow: auto; 
        }

        /* --- UPDATED CELL STRUCTURE --- */
        .day-cell { 
            background-color: white; 
            padding: 0; /* Padding moved to inner content */
            min-height: 100px; 
            display: flex; flex-direction: column; position: relative; 
            overflow: hidden; /* Hides resizer overflow, not content */
        }
        
        .cell-content {
            flex: 1;
            padding: 8px; /* Padding for content */
            overflow-y: auto; /* SCROLLBAR HERE */
            display: flex;
            flex-direction: column;
            min-height: 0; /* Necessary for nested flex scrolling */
        }

        /* Headers don't scroll */
        .day-cell.header { 
            background-color: #f9fafb; font-weight: bold; text-align: center; 
            min-height: 40px; padding: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; overflow: visible; z-index: 5;
        }

        /* Resizers */
        .resizer-col {
            position: absolute; top: 0; right: 0; width: 10px; 
            height: 100%; cursor: col-resize; z-index: 20; opacity: 0;
        }
        .resizer-col:hover { opacity: 1; background-color: rgba(59, 130, 246, 0.3); }

        .resizer-row {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 10px; 
            cursor: row-resize; z-index: 20; opacity: 0;
        }
        .resizer-row:hover { opacity: 1; background-color: rgba(59, 130, 246, 0.3); }

        .day-cell.drag-over { background-color: #e0f2fe !important; border: 2px dashed var(--primary); }
        .day-number { font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: #6b7280; flex-shrink: 0; pointer-events: none; }
        .not-current-month { background-color: #fafafa; color: #d1d5db; }
        
        .stats-cell { background-color: #f9fafb; padding: 8px; display: flex; flex-direction: column; justify-content: flex-start; gap: 2px; border-left: 2px solid var(--border); overflow-y: auto; min-height: 0; }
        .stats-cell .calendar-item { width: 100%; margin-bottom: 4px; }

        .calendar-item {
            font-size: 0.75rem; padding: 3px 6px; margin-bottom: 4px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: grab; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); font-weight: 500; border-left: 4px solid transparent; flex-shrink: 0; user-select: none;
        }
        .calendar-item:active { cursor: grabbing; }
        .prio-high { border-left-color: var(--danger); }
        .prio-medium { border-left-color: var(--warning); }
        .prio-low { border-left-color: var(--success); }

        #sql-view { flex: 1; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .sql-wrapper { display: flex; gap: 20px; flex: 1; overflow: hidden; }
        .sql-main { flex: 3; display: flex; flex-direction: column; gap: 10px; min-width: 0; }
        .sql-editor { width: 100%; height: 100px; background-color: var(--code-bg); color: var(--code-text); font-family: monospace; padding: 10px; border-radius: 6px; border: 1px solid #374151; resize: none; }
        .sql-results-container { flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 6px; }
        .sql-sidebar { flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 15px; overflow: hidden; border-left: 1px solid var(--border); padding-left: 20px; }
        .sidebar-box { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .schema-list, .history-list { flex: 1; overflow-y: auto; background: #f9fafb; border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .history-item { font-size: 0.75rem; padding: 6px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .history-item:hover { background-color: #e5e7eb; }
        table.sql-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        table.sql-table th { background: #f9fafb; padding: 10px; text-align: left; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        table.sql-table td { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; }

        .view-week #calendar-container { grid-template-rows: auto 1fr; grid-auto-rows: unset; }
        .view-year #calendar-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); grid-template-rows: none !important; grid-auto-rows: max-content !important; gap: 20px; background: transparent; border: none; overflow-y: auto !important; padding-right: 5px; align-content: start; }
        .month-card { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; height: auto; min-height: min-content; }
        .month-event-list { flex: 1; overflow-y: auto; max-height: 250px; min-height: 50px; }
        .mini-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 5px; }
        .mini-day { font-size: 0.75rem; text-align: center; aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; border-radius: 50%; color: var(--text); border: 2px solid transparent; }
        .year-event-item { padding: 6px; margin-bottom: 5px; border-radius: 4px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; color: white; cursor: pointer; }
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; border: 1px solid rgba(255,255,255,0.8); }

        #create-view, #category-modal, #delete-options-modal, #event-modal { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; overflow-y: auto; max-height: 90vh; }
        #modal-overlay, #delete-modal-overlay, #event-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        #delete-modal-overlay { z-index: 200; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
        .cat-list { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; max-height: 200px; overflow-y: auto; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .cat-item:hover { background-color: #f9fafb; }
        .cat-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; display: inline-block; }
        .delete-icon { color: var(--danger); cursor: pointer; padding: 0 5px; font-weight: bold; }
    </style>
</head>
<body>

    <input type="file" id="file-input" accept=".json" style="display: none;" onchange="handleFileSelect(event)">

    <div id="modal-overlay" class="hidden">
        <div id="category-modal">
            <h3 style="margin-top:0">Manage Categories</h3>
            <form onsubmit="handleCategorySubmit(event)">
                <div class="form-group"><label>Name</label><input type="text" id="cat-name" required></div>
                <div class="form-group"><label>Color</label><div class="flex"><input type="color" id="cat-color" value="#3b82f6" style="height: 40px; width: 60px; padding: 0; border: none;"><input type="text" id="cat-color-text" value="#3b82f6" readonly style="flex:1;"></div></div>
                <div class="flex" style="justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn" onclick="toggleCategoryModal(false)">Close</button>
                    <div><button type="button" id="btn-cat-clear" class="btn hidden" onclick="clearCategoryForm()">Cancel</button><button type="submit" class="btn btn-primary" id="btn-cat-save">Add</button></div>
                </div>
            </form>
            <div class="cat-list" id="cat-list-container"></div>
        </div>
    </div>

    <div id="delete-modal-overlay" class="hidden">
        <div id="delete-options-modal">
            <h3 style="margin-top:0; color: var(--danger);">Delete Category</h3>
            <div class="flex-col" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmCategoryDelete('move')">Move events to "General"</button>
                <button class="btn btn-danger" onclick="confirmCategoryDelete('delete')">Delete events also</button>
                <button class="btn" onclick="closeDeleteModal()" style="margin-top: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="event-modal-overlay" class="hidden">
        <div id="event-modal">
            <div class="flex-between" style="margin-bottom: 20px;">
                <h2 style="margin:0">Event Info</h2>
                <button type="button" class="btn" onclick="closeEventModal()">&times;</button>
            </div>
            <form id="create-form" onsubmit="handleItemSubmit(event)">
                <div class="form-group"><label>Event Name</label><input type="text" id="inp-name" required></div>
                <div class="flex">
                    <div class="form-group" style="flex: 1;"><label>Date</label><input type="date" id="inp-date" required></div>
                    <div class="form-group" style="flex: 1;"><label>Priority</label>
                        <select id="inp-priority">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Category</label><select id="inp-category" required style="width:100%"></select></div>
                <div class="form-group"><label>Description</label><textarea id="inp-desc" rows="3"></textarea></div>
                <div class="flex" style="justify-content: space-between; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeEventModal()">Cancel</button>
                    <div class="flex">
                        <button type="button" id="btn-delete-event" class="btn btn-danger hidden" onclick="deleteEvent()">Delete Event</button>
                        <button type="submit" class="btn btn-primary">Save Event</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <header>
        <div class="flex-between" style="width: 100%;">
            <div class="flex" style="align-items: center;">
                <h2 id="current-date-display" style="margin:0;">Date</h2>
                <span id="loading-status" style="font-size:0.8rem; color:#6b7280; margin-left:10px;"></span>
            </div>
            <div class="controls">
                <button class="btn btn-green" onclick="downloadData()">&#128190; Save & Backup</button>
                <button class="btn" onclick="triggerFileUpload()">&#128193; Load</button>
                <span>&nbsp;|&nbsp;</span>
                <button class="btn" onclick="changeOffset(-1)">&lt;</button>
                <button class="btn" onclick="changeOffset(1)">&gt;</button>
                <button class="btn" onclick="setView('week')" id="btn-week">Week</button>
                <button class="btn" onclick="setView('month')" id="btn-month">Month</button>
                <button class="btn" onclick="setView('year')" id="btn-year">Year</button>
                <button class="btn btn-dark" onclick="setView('sql')" id="btn-sql">SQL</button>
                <span>&nbsp;|&nbsp;</span>
                <button class="btn btn-primary" onclick="openEventForm()">+ New</button>
            </div>
        </div>
        
        <div class="flex-between" style="border-top: 1px solid var(--border); padding-top: 10px;">
            <div class="flex">
                <button class="btn btn-active" id="btn-toggle-filters" onclick="toggleFilterPanel()">&#9881; Filter</button>
                <button class="btn" onclick="toggleCategoryModal(true)">Cats</button>
            </div>
            <div id="year-controls" class="flex hidden">
                <span style="font-size: 0.9rem; color: #6b7280; align-self: center;">Year Mode:</span>
                <button class="btn" id="btn-mode-list" onclick="setYearMode('list')">List</button>
                <button class="btn" id="btn-mode-grid" onclick="setYearMode('grid')">Grid</button>
            </div>
        </div>

        <div id="filter-panel" class="hidden">
            <div class="filter-section" style="flex: 2;">
                <h4>Categories <span style="font-size: 0.7em; cursor: pointer; color: var(--primary);" onclick="toggleAllCategories()">[Toggle All]</span></h4>
                <div id="filter-cat-container" class="flex-wrap"></div>
            </div>
            <div class="filter-section">
                <h4>Priorities</h4>
                <div id="filter-prio-container" class="flex-wrap">
                    <div class="chip active" onclick="togglePrio('high', this)"><span class="chip-dot" style="background:var(--danger)"></span>High</div>
                    <div class="chip active" onclick="togglePrio('medium', this)"><span class="chip-dot" style="background:var(--warning)"></span>Medium</div>
                    <div class="chip active" onclick="togglePrio('low', this)"><span class="chip-dot" style="background:var(--success)"></span>Low</div>
                </div>
            </div>
            <div class="filter-section" style="flex: 0 0 200px;">
                <h4>Settings</h4>
                <div class="flex-col">
                    <select class="input-select" onchange="setSort(this.value)" style="width: 100%;">
                        <option value="priority_desc" selected>Sort: Prio (High)</option>
                        <option value="priority_asc">Sort: Prio (Low)</option>
                        <option value="category_asc">Sort: Category</option>
                        <option value="date_asc">Sort: Date (Old)</option>
                        <option value="date_desc">Sort: Date (New)</option>
                        <option value="name_asc">Sort: Name (A-Z)</option>
                    </select>
                    <button class="btn" onclick="resetLayout()">Reset Layout Sizes</button>
                </div>
            </div>
        </div>
    </header>

    <div id="calendar-view">
        <div id="calendar-container"></div>
    </div>

    <div id="sql-view" class="hidden">
        <div class="flex-between">
            <h2 style="margin:0">SQL Query</h2>
            <div class="flex-wrap" style="justify-content: flex-end;">
                <button class="btn" onclick="setSqlQuery('SELECT * FROM events')">All</button>
                <button class="btn" onclick="setSqlQuery('SELECT category_name, COUNT(*) as [Total] FROM events GROUP BY category_name')">By Cat</button>
                <button class="btn" onclick="setSqlQuery('SELECT d.date, d.day_name FROM dates d LEFT JOIN events e ON d.date = e.date WHERE e.id IS NULL AND d.year = 2025 LIMIT 20')">Empty Days</button>
            </div>
        </div>
        <div class="sql-wrapper">
            <div class="sql-main">
                <textarea id="sql-input" class="sql-editor" placeholder="SELECT * FROM events..."></textarea>
                <button class="btn btn-primary" onclick="runQuery()" style="align-self: flex-start;">Run Query</button>
                <div class="sql-results-container"><table id="sql-results" class="sql-table"><thead><tr><th>Results</th></tr></thead><tbody></tbody></table></div>
            </div>
            <div class="sql-sidebar">
                <div class="sidebar-box">
                    <div class="sidebar-title">Structure</div>
                    <div class="schema-list" id="schema-list"></div>
                </div>
                <div class="sidebar-box" style="flex: 0 0 40%;">
                    <div class="sidebar-title">History</div>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let events = [];
        let categories = [ { id: 'default', name: 'General', color: '#6b7280' } ];
        let queryHistory = [];
        let layoutState = { colWidths: Array(7).fill('minmax(100px, 1fr)'), statsWidth: '160px', rowHeights: {} };
        let state = { view: 'month', currentDate: new Date(), yearMode: 'list', activeCategories: new Set(['default']), activePriorities: new Set(['high', 'medium', 'low']), sortBy: 'priority_desc', editingEventId: null, editingCategoryId: null, categoryPendingDelete: null, filterPanelOpen: false };
        let currentViewRowIds = []; 

        // --- GRID RESIZING ---
        let resizing = null;
        function initResize(e, type, index, initialVal) {
            e.preventDefault(); e.stopPropagation();
            resizing = { type, index, startX: e.clientX, startY: e.clientY, startVal: parseFloat(initialVal) || 100 };
            document.body.style.cursor = type === 'col' ? 'col-resize' : 'row-resize';
            document.addEventListener('mousemove', handleResizeMove);
            document.addEventListener('mouseup', stopResize);
        }
        function handleResizeMove(e) {
            if (!resizing) return;
            const container = document.getElementById('calendar-container');
            if (resizing.type === 'col') {
                const delta = e.clientX - resizing.startX;
                const newVal = Math.max(80, resizing.startVal + delta) + 'px';
                layoutState.colWidths[resizing.index] = newVal;
                const cols = [...layoutState.colWidths, layoutState.statsWidth].join(' ');
                container.style.gridTemplateColumns = cols;
            } else if (resizing.type === 'row') {
                const delta = e.clientY - resizing.startY;
                const newVal = Math.max(100, resizing.startVal + delta) + 'px';
                const rowId = currentViewRowIds[resizing.index]; 
                if (rowId) {
                    layoutState.rowHeights[rowId] = newVal;
                    const rowsCss = currentViewRowIds.map(rid => layoutState.rowHeights[rid] || 'minmax(100px, 1fr)');
                    const finalRowCss = ['auto', ...rowsCss].join(' ');
                    container.style.gridTemplateRows = finalRowCss;
                }
            }
        }
        function stopResize() {
            resizing = null; document.body.style.cursor = 'default';
            document.removeEventListener('mousemove', handleResizeMove); document.removeEventListener('mouseup', stopResize);
            saveToLocal();
        }
        function resetLayout() { layoutState = { colWidths: Array(7).fill('minmax(100px, 1fr)'), statsWidth: '160px', rowHeights: {} }; saveToLocal(); render(); }

        // --- PERSISTENCE ---
        function saveToLocal() { const payload = { events, categories, appState: { ...state, activeCategories: Array.from(state.activeCategories), activePriorities: Array.from(state.activePriorities), queryHistory }, layoutState, savedAt: new Date().toISOString() }; localStorage.setItem('calendar_app_data', JSON.stringify(payload)); }
        async function loadFromLocal() { const local = localStorage.getItem('calendar_app_data'); if(local) { try { const data = JSON.parse(local); applyData(data); return; } catch(e) {} } try { const res = await fetch('calendar_backup.json'); if(res.ok) { const data = await res.json(); applyData(data); } } catch(e) {} }
        function applyData(data) { if(data.events) events = data.events; if(data.categories) categories = data.categories; if(data.layoutState) layoutState = data.layoutState; if(data.appState) { const s = data.appState; Object.assign(state, s); state.activeCategories = new Set(s.activeCategories); state.activePriorities = new Set(s.activePriorities); state.currentDate = new Date(s.currentDate); if(s.queryHistory) queryHistory = s.queryHistory; document.querySelector('.input-select').value = state.sortBy; if(state.filterPanelOpen) { document.getElementById('filter-panel').classList.remove('hidden'); document.getElementById('btn-toggle-filters').classList.add('btn-active'); } }
            if(!layoutState.colWidths || layoutState.colWidths.length !== 7) layoutState.colWidths = Array(7).fill('minmax(100px, 1fr)');
            updateCategoryDropdowns(); renderHistory(); render();
        }

        // --- DRAG DROP ---
        let draggedEventId = null;
        function handleDragStart(e, id) { draggedEventId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleDrop(e, dateStr) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); if (draggedEventId) { const idx = events.findIndex(e=>e.id===draggedEventId); if(idx!==-1){ events[idx].date = dateStr; saveToLocal(); render(); } draggedEventId = null; } }

        function createEventElement(item) { const color = getCategoryColor(item.categoryId); const el = document.createElement('div'); el.className = `calendar-item prio-${item.priority}`; el.innerText = item.name; el.title = `${item.name} (${item.priority})`; el.style.backgroundColor = color; el.draggable = true; el.ondragstart = (e) => handleDragStart(e, item.id); el.onclick = (e) => { e.stopPropagation(); openEventForm(item.id); }; return el; }

        // --- SQL ---
        function setSqlQuery(q) { document.getElementById('sql-input').value = q; runQuery(); }
        function runQuery() { const query = document.getElementById('sql-input').value; const tableHead = document.querySelector('#sql-results thead'); const tableBody = document.querySelector('#sql-results tbody'); const flatEvents = events.map(e => { const cat = categories.find(c => String(c.id) === String(e.categoryId)) || {name:'Unknown', color:'#ccc'}; const d = new Date(e.date + 'T00:00:00'); const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']; const months = ['January','February','March','April','May','June','July','August','September','October','November','December']; return { id: e.id, name: e.name, date: e.date, priority: e.priority, description: e.description, category_name: cat.name, category_color: cat.color, day_name: days[d.getDay()], month_name: months[d.getMonth()], year: d.getFullYear(), day: d.getDate() }; }); const calendarDates = []; const startYear = new Date().getFullYear() - 2; const endYear = new Date().getFullYear() + 2; const start = new Date(startYear, 0, 1); const end = new Date(endYear, 11, 31); const daysArr = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']; for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { calendarDates.push({ date: formatDateSafe(d), day_name: daysArr[d.getDay()], year: d.getFullYear() }); } try { if (!alasql.databases.cal) alasql('CREATE DATABASE cal'); alasql('USE cal'); alasql('DROP TABLE IF EXISTS events'); alasql('CREATE TABLE events'); alasql('SELECT * INTO events FROM ?', [flatEvents]); alasql('DROP TABLE IF EXISTS dates'); alasql('CREATE TABLE dates'); alasql('SELECT * INTO dates FROM ?', [calendarDates]); renderSchema(); const res = alasql(query); if(query.trim() && !queryHistory.includes(query)) { queryHistory.unshift(query); if(queryHistory.length > 20) queryHistory.pop(); renderHistory(); saveToLocal(); } tableHead.innerHTML = ''; tableBody.innerHTML = ''; if (!res || res.length === 0) { tableBody.innerHTML = '<tr><td style="padding:10px; color:#666;">No results found.</td></tr>'; return; } const headers = Object.keys(res[0]); let headRow = '<tr>'; headers.forEach(h => headRow += `<th>${h}</th>`); headRow += '</tr>'; tableHead.innerHTML = headRow; res.forEach(row => { let tr = '<tr>'; headers.forEach(h => tr += `<td>${row[h]}</td>`); tr += '</tr>'; tableBody.innerHTML += tr; }); } catch (err) { tableHead.innerHTML = '<tr><th>Error</th></tr>'; tableBody.innerHTML = `<tr><td style="color:red;">${err.message}</td></tr>`; } }
        function renderSchema() { document.getElementById('schema-list').innerHTML = `<div class="schema-table"><div class="schema-table-name">Table: events</div><div class="schema-col">id, name, date, priority, description, category_name, day_name, month_name, year</div></div><div class="schema-table"><div class="schema-table-name">Table: dates</div><div class="schema-col">date, day_name, year</div></div>`; }
        function renderHistory() { const container = document.getElementById('history-list'); container.innerHTML = ''; queryHistory.forEach(q => { const d=document.createElement('div'); d.className='history-item'; d.innerText=q; d.title=q; d.onclick=()=>setSqlQuery(q); container.appendChild(d); }); }

        async function fetchHolidays() { const statusEl = document.getElementById('loading-status'); statusEl.innerText = "Fetching holidays..."; const years = [2025, 2026, 2027]; let newHolidaysCount = 0; let holidayCat = categories.find(c => c.name === 'Public Holiday'); let holidayCatId = holidayCat ? holidayCat.id : 'holidays_' + Date.now(); if (!holidayCat) { categories.push({ id: holidayCatId, name: 'Public Holiday', color: '#ef4444' }); state.activeCategories.add(holidayCatId); } else { if (!state.activeCategories.has(holidayCatId)) state.activeCategories.add(holidayCatId); } try { for (let year of years) { const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/BR`); if (!response.ok) continue; const data = await response.json(); data.forEach(h => { const uniqueId = `hol_${h.date}_${h.localName.replace(/\s/g, '')}`; if (!events.find(ev => ev.id === uniqueId)) { events.push({ id: uniqueId, name: h.localName, date: h.date, categoryId: holidayCatId, priority: 'high', description: `${h.name} (Public Holiday)` }); newHolidaysCount++; } }); } statusEl.innerText = ""; if(newHolidaysCount > 0) { renderFilters(); render(); saveToLocal(); } } catch (err) { statusEl.innerText = "Offline mode"; } }
        
        function formatDateSafe(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
        function toggleFilterPanel() { state.filterPanelOpen = !state.filterPanelOpen; const panel = document.getElementById('filter-panel'); const btn = document.getElementById('btn-toggle-filters'); if(state.filterPanelOpen) { panel.classList.remove('hidden'); btn.classList.add('btn-active'); } else { panel.classList.add('hidden'); btn.classList.remove('btn-active'); } saveToLocal(); }
        function renderFilters() { const container = document.getElementById('filter-cat-container'); container.innerHTML = ''; categories.forEach(cat => { const chip = document.createElement('div'); const isActive = state.activeCategories.has(String(cat.id)); chip.className = `chip ${isActive ? 'active' : ''}`; chip.innerHTML = `<span class="chip-dot" style="background:${cat.color}"></span>${cat.name}`; if(isActive) { chip.style.borderColor = cat.color; chip.style.color = cat.color; } chip.onclick = () => toggleCategoryFilter(String(cat.id)); container.appendChild(chip); }); }
        function toggleCategoryFilter(id) { const idStr = String(id); if (state.activeCategories.has(idStr)) state.activeCategories.delete(idStr); else state.activeCategories.add(idStr); renderFilters(); render(); saveToLocal(); }
        function toggleAllCategories() { const allIds = categories.map(c => String(c.id)); if (state.activeCategories.size === allIds.length) state.activeCategories.clear(); else state.activeCategories = new Set(allIds); renderFilters(); render(); saveToLocal(); }
        function togglePrio(prio, el) { if (state.activePriorities.has(prio)) { state.activePriorities.delete(prio); el.classList.remove('active'); } else { state.activePriorities.add(prio); el.classList.add('active'); } render(); saveToLocal(); }
        function setSort(val) { state.sortBy = val; render(); saveToLocal(); }
        function setYearMode(mode) { state.yearMode = mode; render(); saveToLocal(); }
        function getCategoryName(id) { const cat = categories.find(c => String(c.id) === String(id)); return cat ? cat.name : ''; }
        function getCategoryColor(catId) { const cat = categories.find(c => String(c.id) === String(catId)); return cat ? cat.color : '#6b7280'; }
        function getFilteredAndSortedEvents() { let filtered = events.filter(ev => { const catMatch = state.activeCategories.has(String(ev.categoryId)); const prioMatch = state.activePriorities.has(ev.priority); return catMatch && prioMatch; }); const prioMap = { 'high': 3, 'medium': 2, 'low': 1 }; filtered.sort((a, b) => { const prioA = prioMap[a.priority] || 0; const prioB = prioMap[b.priority] || 0; const catA = getCategoryName(a.categoryId).toLowerCase(); const catB = getCategoryName(b.categoryId).toLowerCase(); switch(state.sortBy) { case 'category_asc': if(catA !== catB) return catA.localeCompare(catB); return prioB - prioA; case 'priority_desc': if(prioA !== prioB) return prioB - prioA; return catA.localeCompare(catB); case 'priority_asc': if(prioA !== prioB) return prioA - prioB; return catA.localeCompare(catB); case 'date_asc': if(a.date !== b.date) return new Date(a.date) - new Date(b.date); return prioB - prioA; case 'date_desc': if(a.date !== b.date) return new Date(b.date) - new Date(a.date); return prioB - prioA; case 'name_asc': if(a.name !== b.name) return a.name.localeCompare(b.name); return prioB - prioA; default: return 0; } }); return filtered; }
        function getWeeklyListHTML(items) { if(!items || items.length === 0) return `<div style="color:#9ca3af; font-size:0.75rem; text-align:center; padding:5px;">No events</div>`; return items.map(ev => { const color = getCategoryColor(ev.categoryId); const day = ev.date.split('-')[2]; return `<div class="calendar-item prio-${ev.priority}" style="background-color:${color}; display: flex; justify-content: space-between; align-items: center;" onclick="openEventForm('${ev.id}')" title="${ev.name}"><span style="overflow: hidden; text-overflow: ellipsis; flex: 1;">${ev.name}</span><span style="opacity: 0.8; font-size: 0.9em; margin-left: 5px; flex-shrink: 0;">${day}</span></div>`; }).join(''); }
        function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day; return new Date(d.setDate(diff)); }

        // --- RENDER MAIN ---
        function setView(v) { state.view = v; render(); saveToLocal(); }
        function changeOffset(dir) { if (state.view === 'month') state.currentDate.setMonth(state.currentDate.getMonth() + dir); else if (state.view === 'week') state.currentDate.setDate(state.currentDate.getDate() + (dir * 7)); else if (state.view === 'year') state.currentDate.setFullYear(state.currentDate.getFullYear() + dir); state.currentDate = new Date(state.currentDate); render(); saveToLocal(); }
        function updateCategoryDropdowns() { const s = document.getElementById('inp-category'); const v = s.value; s.innerHTML = ''; categories.forEach(cat => { const opt = document.createElement('option'); opt.value = cat.id; opt.innerText = cat.name; s.appendChild(opt); }); s.value = [...s.options].some(o=>o.value==v) ? v : 'default'; renderFilters(); }
        function handleItemSubmit(e) { e.preventDefault(); const eventData = { id: state.editingEventId ? state.editingEventId : Date.now(), name: document.getElementById('inp-name').value, description: document.getElementById('inp-desc').value, categoryId: document.getElementById('inp-category').value, date: document.getElementById('inp-date').value, priority: document.getElementById('inp-priority').value }; if (state.editingEventId) { const index = events.findIndex(ev => ev.id === state.editingEventId); if(index !== -1) events[index] = eventData; } else { events.push(eventData); } saveToLocal(); closeEventModal(); render(); }
        function handleCategorySubmit(e) { e.preventDefault(); const name = document.getElementById('cat-name').value; const color = document.getElementById('cat-color').value; if (state.editingCategoryId) { const cat = categories.find(c => c.id === state.editingCategoryId); if(cat) { cat.name = name; cat.color = color; } } else { const newId = String(Date.now()); categories.push({ id: newId, name, color }); state.activeCategories.add(newId); } clearCategoryForm(); toggleCategoryModal(false); saveToLocal(); updateCategoryDropdowns(); render(); }
        function confirmCategoryDelete(action) { const id = state.categoryPendingDelete; if(!id) return; const idStr = String(id); if (action === 'move') events.forEach(ev => { if (String(ev.categoryId) === idStr) ev.categoryId = 'default'; }); else if (action === 'delete') events = events.filter(ev => String(ev.categoryId) !== idStr); categories = categories.filter(c => String(c.id) !== idStr); if(state.activeCategories.has(idStr)) state.activeCategories.delete(idStr); closeDeleteModal(); saveToLocal(); updateCategoryDropdowns(); renderCategoryList(); render(); }
        function downloadData() { const payload = { events, categories, appState: { ...state, activeCategories: Array.from(state.activeCategories), activePriorities: Array.from(state.activePriorities), queryHistory }, layoutState, savedAt: new Date().toISOString() }; const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `calendar_backup.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function triggerFileUpload() { document.getElementById('file-input').click(); }
        function handleFileSelect(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const json = JSON.parse(e.target.result); applyData(json); alert("Data loaded!"); } catch (err) { alert("Error reading file."); } }; reader.readAsText(file); event.target.value = ''; }
        function openEventForm(id){ state.editingEventId = id; document.getElementById('event-modal-overlay').classList.remove('hidden'); if(id){const ev=events.find(e=>e.id==id); document.getElementById('inp-name').value=ev.name; document.getElementById('inp-date').value=ev.date; document.getElementById('inp-priority').value=ev.priority; document.getElementById('inp-category').value=ev.categoryId; document.getElementById('inp-desc').value=ev.description; document.getElementById('btn-delete-event').classList.remove('hidden');}else{document.getElementById('create-form').reset(); document.getElementById('inp-date').value=new Date().toISOString().split('T')[0]; document.getElementById('btn-delete-event').classList.add('hidden');} }
        function closeEventModal() { document.getElementById('event-modal-overlay').classList.add('hidden'); }
        function deleteEvent(){ if(!state.editingEventId)return; if(confirm("Delete event?")){events=events.filter(e=>e.id!==state.editingEventId); saveToLocal(); closeEventModal(); render();} }
        function promptDeleteCategory(id){ state.categoryPendingDelete=id; document.getElementById('delete-modal-overlay').classList.remove('hidden'); }
        function closeDeleteModal(){ state.categoryPendingDelete=null; document.getElementById('delete-modal-overlay').classList.add('hidden'); }
        function toggleCategoryModal(s){ const m=document.getElementById('modal-overlay'); if(s){m.classList.remove('hidden'); clearCategoryForm(); renderCategoryList();}else{m.classList.add('hidden');} }
        function clearCategoryForm(){ state.editingCategoryId=null; document.getElementById('cat-name').value=''; document.getElementById('cat-color').value='#3b82f6'; document.getElementById('cat-color-text').value='#3b82f6'; document.getElementById('btn-cat-save').innerText='Add'; document.getElementById('btn-cat-clear').classList.add('hidden'); }
        function renderCategoryList(){ const l=document.getElementById('cat-list-container'); l.innerHTML=''; categories.forEach(c=>{ const d=document.createElement('div'); d.className='cat-item'; d.innerHTML=`<div onclick="loadCat('${c.id}')"><span class="cat-dot" style="background:${c.color}"></span>${c.name}</div>${c.id!=='default'?`<div class="delete-icon" onclick="promptDeleteCategory('${c.id}')">&times;</div>`:''}`; l.appendChild(d); }); }
        function loadCat(id){ const c=categories.find(x=>x.id==id); if(!c)return; state.editingCategoryId=id; document.getElementById('cat-name').value=c.name; document.getElementById('cat-color').value=c.color; document.getElementById('cat-color-text').value=c.color; document.getElementById('btn-cat-save').innerText='Update'; document.getElementById('btn-cat-clear').classList.remove('hidden'); }

        function render() {
            const finalEvents = getFilteredAndSortedEvents();
            const options = { year: 'numeric', month: 'long' };
            if (state.view === 'week') options.day = 'numeric';
            document.getElementById('current-date-display').innerText = state.currentDate.toLocaleDateString('en-US', options);

            document.querySelectorAll('.controls .btn').forEach(b => { if(b.id && b.id.startsWith('btn-')) b.classList.remove('btn-primary'); });
            if(document.getElementById(`btn-${state.view}`)) document.getElementById(`btn-${state.view}`).classList.add('btn-primary');

            const container = document.getElementById('calendar-container');
            const viewEl = document.getElementById('calendar-view');
            const sqlView = document.getElementById('sql-view');

            if(state.view === 'sql') {
                container.style.display = 'none'; viewEl.classList.add('hidden'); sqlView.classList.remove('hidden'); document.getElementById('year-controls').classList.add('hidden');
                runQuery(); return;
            } else { container.style.display = 'grid'; viewEl.classList.remove('hidden'); sqlView.classList.add('hidden'); }

            if (state.view === 'year') { document.getElementById('year-controls').classList.remove('hidden'); } else { document.getElementById('year-controls').classList.add('hidden'); }

            container.innerHTML = ''; viewEl.className = `view-${state.view}`; container.style = ''; 

            if (state.view === 'month') {
                const cols = [...layoutState.colWidths, layoutState.statsWidth].join(' ');
                container.style.gridTemplateColumns = cols;
                renderMonth(finalEvents, container);
            } else if (state.view === 'week') {
                const cols = [...layoutState.colWidths, layoutState.statsWidth].join(' ');
                container.style.gridTemplateColumns = cols;
                container.style.gridTemplateRows = 'auto 1fr'; 
                renderWeek(finalEvents, container);
            } else if (state.view === 'year') {
                if(state.yearMode === 'list') renderYearList(finalEvents, container); else renderYearGrid(finalEvents, container);
            }
        }

        function renderMonth(data, container) {
            currentViewRowIds = []; 
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach((d, index) => {
                const el = document.createElement('div'); el.className = 'day-cell header'; el.innerText = d; 
                const resizer = document.createElement('div'); resizer.className = 'resizer-col';
                resizer.onmousedown = (e) => initResize(e, 'col', index, el.offsetWidth);
                el.appendChild(resizer); container.appendChild(el);
            });
            const statsHeader = document.createElement('div'); statsHeader.className = 'day-cell header'; statsHeader.innerText = 'Tasks'; container.appendChild(statsHeader);

            const year = state.currentDate.getFullYear(); const month = state.currentDate.getMonth();
            const firstDayIndex = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            const numWeeks = Math.ceil((firstDayIndex + daysInMonth) / 7);
            
            let rowTemplate = 'auto'; 
            let currentDay = 1 - firstDayIndex;
            
            for(let w = 0; w < numWeeks; w++) {
                const weekStart = new Date(year, month, currentDay);
                const rowId = `row-${weekStart.toISOString().split('T')[0]}`;
                currentViewRowIds.push(rowId); 
                const height = layoutState.rowHeights[rowId] || 'minmax(100px, 1fr)';
                rowTemplate += ` ${height}`;

                for(let d=0; d<7; d++) {
                    const date = new Date(year, month, currentDay);
                    const dateStr = formatDateSafe(date);
                    const isCurrent = date.getMonth() === month;
                    const items = data.filter(ev => ev.date === dateStr);
                    
                    const el = document.createElement('div'); el.className = `day-cell ${!isCurrent ? 'not-current-month' : ''}`;
                    el.ondragover = handleDragOver; el.ondrop = (e) => handleDrop(e, dateStr); el.ondragleave = handleDragLeave;
                    
                    // NEW INNER STRUCTURE
                    const content = document.createElement('div'); content.className = 'cell-content';
                    content.innerHTML = `<div class="day-number">${date.getDate()}</div>`;
                    items.forEach(item => content.appendChild(createEventElement(item)));
                    el.appendChild(content);
                    
                    if(d === 0) {
                        const resizer = document.createElement('div'); resizer.className = 'resizer-row';
                        resizer.onmousedown = (e) => initResize(e, 'row', w, el.offsetHeight); 
                        el.appendChild(resizer);
                    }
                    container.appendChild(el);
                    currentDay++;
                }
                const weekEnd = new Date(year, month, currentDay - 1);
                const weekStartDt = new Date(year, month, currentDay - 7);
                const sStr = formatDateSafe(weekStartDt); const eStr = formatDateSafe(weekEnd);
                const currentRowEvents = data.filter(ev => ev.date >= sStr && ev.date <= eStr);
                const statCell = document.createElement('div'); statCell.className = 'stats-cell'; statCell.innerHTML = getWeeklyListHTML(currentRowEvents); container.appendChild(statCell);
            }
            container.style.gridTemplateRows = rowTemplate;
        }

        function renderWeek(data, container) {
            const start = getStartOfWeek(state.currentDate);
            const end = new Date(start); end.setDate(end.getDate() + 6);
            const sStr = formatDateSafe(start); const eStr = formatDateSafe(end);
            const weekEvents = data.filter(ev => ev.date >= sStr && ev.date <= eStr);

            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const el = document.createElement('div'); el.className = 'day-cell header'; 
                el.innerText = d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
                const resizer = document.createElement('div'); resizer.className = 'resizer-col';
                resizer.onmousedown = (e) => initResize(e, 'col', i, el.offsetWidth);
                el.appendChild(resizer); container.appendChild(el);
            }
            const statsHeader = document.createElement('div'); statsHeader.className = 'day-cell header'; statsHeader.innerText = 'Tasks'; container.appendChild(statsHeader);

            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i); const dateStr = formatDateSafe(d);
                const items = data.filter(ev => ev.date === dateStr);
                const el = document.createElement('div'); el.className = 'day-cell';
                el.ondragover = handleDragOver; el.ondrop = (e) => handleDrop(e, dateStr); el.ondragleave = handleDragLeave;
                
                // NEW INNER STRUCTURE
                const content = document.createElement('div'); content.className = 'cell-content';
                items.forEach(item => content.appendChild(createEventElement(item)));
                el.appendChild(content);
                
                container.appendChild(el);
            }
            const statCell = document.createElement('div'); statCell.className = 'stats-cell'; statCell.innerHTML = getWeeklyListHTML(weekEvents); container.appendChild(statCell);
        }

        window.loadCat = loadCat;
        loadFromLocal().then(() => { if(!events.length) fetchHolidays(); });

    </script>
</body>
</html>